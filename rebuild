#!/bin/bash
set -e
pushd "$HOME/nixos-config" > /dev/null
tmp="tmp.log"
alejandra . 1>/dev/null 2>"$tmp" || (cat "$tmp" && rm -f "$tmp" && false)
rm -f "$tmp"
git diff -U0 *.nix
echo "nah, i'd win"
logfile="rebuild.log"
(
set -o pipefail
( sudo nixos-rebuild switch --flake .#nixos 2>&1 | grep -v "dirty$" | tee "$logfile" ) || ( echo "An error occurred:" && cat "$logfile" | grep --color "error" && false )
# ( home-manager switch --flake .#adaad@nixos 2>&1 | grep -v "dirty$" | tee "$logfile" ) || ( echo "An error occurred:" && cat "$logfile" | grep --color "error" && false )
)
gen=$(nix-env --list-generations | grep 'current' | sed 's/ *(.*//')
git commit -am "Generation $gen"
echo "operation completed successfully :)"
popd
