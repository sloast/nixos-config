#!/bin/bash
set -e
pushd ~/nix-config > /dev/null
alejandra . &>/dev/null
git diff -U0 *.nix
echo "nah, i'd win"
logfile="rebuild.log"
(
set -o pipefail
( sudo nixos-rebuild switch --flake .#nixos 2>&1 | grep -v "dirty$" | tee "$logfile" ) || ( echo "An error occurred:" && cat "$logfile" | grep --color "error" && false )
# ( home-manager switch --flake .#adaad@nixos 2>&1 | grep -v "dirty$" | tee "$logfile" ) || ( echo "An error occurred:" && cat "$logfile" | grep --color "error" && false )
)
git commit -am 'nixos-rebuild'
echo "operation completed successfully :)"
popd
